angular.module("ngApp",["ngRoute","ui.bootstrap","vr.directives.slider"]).config(function($routeProvider,$locationProvider,USER_ROLES,$httpProvider){$routeProvider.when("/",{templateUrl:"start.html",controller:"StartController"}).when("/about",{templateUrl:"about.html",controller:"AboutController",params:USER_ROLES.admin}).otherwise({redirectTo:"/"});$locationProvider.html5Mode(false).hashPrefix("!");return delete $httpProvider.defaults.headers.common["X-Requested-With"]}).value("rootUrl",window.location.host.toUpperCase()==="LOCALHOST:8080"?"http://localhost:3001":"").run(function($rootScope,AUTH_EVENTS,AuthService){return $rootScope.$on("$routeChangeStart",function(event,next,current){if(next.authorizedRoles){if(!AuthService.isAuthorized(next.authorizedRoles)){alert("You are not allowed to access this page because you are not a member of "+next.authorizedRoles);console.log("authorizedRoles",next.authorizedRoles);event.preventDefault();if(AuthService.isAuthenticated){return $rootScope.$broadcast(AUTH_EVENTS.notAuthorized)}else{return $rootScope.$broadcast(AUTH_EVENTS.notAuthenticated)}}}})});if(typeof console==="undefined"){window.console={log:function(){}}}angular.module("ngApp").constant("USER_ROLES",{all:"*",admin:"admin",guest:"guest"}).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"});angular.module("ngApp").factory("AuthService",function($http,Session){return{login:function(credentials){return Session.create("sessionId","alex","admin");return $http.post("/login",credentials).then(function(res){return Session.create(res.id,res.userid,res.role)})},isAuthenticated:function(){return!!Session.userId},isAuthorized:function(authorizedRoles){if(!angular.isArray(authorizedRoles)){authorizedRoles=[authorizedRoles]}return this.isAuthenticated()&&authorizedRoles.indexOf(Session.userRole!==-1)}}});angular.module("ngApp").service("ImageLoader",function($http,rootUrl){this.interval=5e3;this.updateInterval=function(_this){return function(interval){if(interval<=600){console.error("The interval must be at least 600 (ms)");return}return _this.resetTimeout()}}(this);this.create=function(_this){return function(updateCurrentImage){_this.images=[];_this.index=-1;_this.updateCurrentImage=updateCurrentImage;_this.resetTimeout();_this.displayNext();return _this}}(this);this.resetTimeout=function(_this){return function(){if(_this.timer&&_this.timer>0){clearTimeout(_this.timer)}return _this.timer=setTimeout(_this.onTick,_this.interval)}}(this);this.add=function(_this){return function(img){if(!angular.isArray(img)){img=[img]}return _this.images.concat(img)}}(this);this.hasMoreImages=function(_this){return function(){return _this.index+1<_this.images.length}}(this);this.displayNext=function(_this){return function(){if(!_this.hasMoreImages()){if(_this.index===-1||!_this.images||_this.images.length<_this.index){return $http.get(""+rootUrl+"/api/pics",{}).success(function(result){return _.each(result.images,function(i){return _this.load(i)})}).error(function(data,status,headers,config){return console.log(""+status+" failed to retrieve first images")})}else{return $http.post(""+rootUrl+"/api/pics/next",{fromId:_this.images[_this.index]._id}).success(function(result){return _.each(result.images,function(i){return _this.load(i)})}).error(function(data,status,headers,config){return console.log(""+status+" Failed to retrieve images.")})}}if(_this.images.length===0){return}if(_this.index+1<_this.images.length){_this.index++}else{_this.index=0}return _this.updateCurrentImage(_this.images[_this.index])}}(this);this.displayPrevious=function(_this){return function(){if(_this.index>0){_this.index--}return _this.updateCurrentImage(_this.images[_this.index])}}(this);this.onTick=function(_this){return function(){_this.displayNext();return _this.timer=setTimeout(_this.onTick,_this.interval)}}(this);this.load=function(_this){return function(imgsrc){var img1,p,_results;img1=new Image;img1.onload=function(){_this.images.push(img1);if(_this.images.length===1){return _this.displayNext()}};_results=[];for(p in imgsrc){_results.push(img1[p]=imgsrc[p])}return _results}}(this);return this});angular.module("ngApp").service("Session",function(){this.create=function(sessionId,userId,userRole){this.id=sessionId;this.userId=userId;this.userRole=userRole;return this};this.destroy=function(){this.id=null;this.userId=null;this.userRole=null;return this};return this});angular.module("ngApp").directive("focusMe",function($timeout,$parse){return{link:function(scope,element,attrs){var model;model=$parse(attrs.focusMe);scope.$watch(model,function(value){if(value===true){return $timeout(function(){return element[0].focus()})}});return element.bind("blur",function(){return scope.$apply(model.assign(scope,false))})}}});angular.module("ngApp").controller("AboutController",function($scope){});angular.module("ngApp").controller("AddImageController",function($scope,$http,rootUrl){$scope.focusImageUrl=true;$scope.addResult="";$scope.closeModal=function(){return $scope.$close()};return $scope.add=function(_this){return function(image){if(!image||image.imageUrl.indexOf("http://")!==0&&image.imageUrl.indexOf("https://")!==0){return $scope.addResult="Please enter an address starting with http:// or https://"}return $http.post(""+rootUrl+"/api/pics",{src:image.imageUrl,title:image.title}).success(function(result){var scopeImg;scopeImg=angular.element($("#addImageForm")).scope().image;scopeImg.imageUrl="";scopeImg.title="";return $scope.addResult="Image added successfully."}).error(function(data,status,headers,config){return $scope.addResult=""+status+" Failed to add the image."})}}(this)});angular.module("ngApp").controller("ApplicationController",function($scope,USER_ROLES,$modal,AUTH_EVENTS){$scope.currentUser=null;$scope.userRoles=USER_ROLES;$scope.isAuthorized=false;$scope.showLogin=function(){var loginModal;loginModal=$modal.open({templateUrl:"loginModal.html",controller:"LoginController",backdrop:false,keyboard:true});return loginModal.result.then(function(){console.log("succ");return loginModal=void 0},function(){console.log("cancelled");return loginModal=void 0})};return $scope.$on(AUTH_EVENTS.loginSuccess,function(event,user){return $scope.currentUser=user})});angular.module("ngApp").controller("LoginController",function($scope,$rootScope,AUTH_EVENTS,AuthService,$modalInstance){$scope.credentials={username:"",password:""};$scope.ok=function(){return $modalInstance.dismiss()};return $scope.login=function(credentials){AuthService.login(credentials);console.log("credentials",credentials);$rootScope.$broadcast(AUTH_EVENTS.loginSuccess,{name:"Alex ("+credentials.username+")"});return $modalInstance.close()}});angular.module("ngApp").controller("StartController",function($scope,ImageLoader,$modal){$scope.imageContainer=$("#fullscreen");$scope.image=$("#fullscreen img");$scope.keys="";$scope.currentImage={src:""};this.imageLoader=ImageLoader.create(function(photo){var imageRatio,ratioDiff,resizeDiff,screenRatio,windowSize;$scope.currentImage=photo;windowSize={x:$(document).width(),y:$(document).height()};screenRatio=windowSize.x/windowSize.y;imageRatio=photo.width/photo.height;ratioDiff=(screenRatio/imageRatio).toFixed(2);$scope.imageDetails.title=photo.title.length?photo.title:"";$scope.imageDetails.screenRatio="Screen ratio: "+screenRatio.toFixed(2);$scope.imageDetails.imageRatio="Image ratio: "+imageRatio.toFixed(2);$scope.imageDetails.ratioDiff="Ratio diff: "+ratioDiff;if(ratioDiff>1.5){resizeDiff=0;if(photo.width>photo.height){resizeDiff=windowSize.x/photo.width;console.log("landscape x "+photo.width+" y "+photo.height);$scope.image.css("width",windowSize.x);$scope.image.css("height",resizeDiff*photo.height)}else{console.log("portrait x "+photo.width+" y "+photo.height);resizeDiff=windowSize.y/photo.height;$scope.image.css("height",windowSize.y);$scope.image.css("width",resizeDiff*photo.width)}$scope.imageDetails.resizeDiff="Resize diff: "+resizeDiff.toFixed(2);$scope.image.attr("src",photo.src);$scope.imageContainer.css("background-image","");$scope.image.show()}else{$scope.imageDetails.resizeDiff="";$scope.image.attr("src","");$scope.image.hide();$scope.imageContainer.css("background-image","url("+photo.src+")")}$scope.image.attr("alt",photo.title);return $scope.$apply()});$scope.hasFullScreen=function(){var i;i=document.getElementById("fullscreen");return i.requestFullscreen||i.webkitRequestFullscreen||i.mozRequestFullScreen||i.msRequestFullscreen};if(!$scope.hasFullScreen()){$(".js-enter-fullscreen").hide()}$("body").keyup(function(_this){return function(e){if(e.keyCode===37){$scope.keys+="LEFT ";_this.imageLoader.displayPrevious()}else if(e.keyCode===39){$scope.keys+="RIGHT ";_this.imageLoader.displayNext()}return $scope.$apply()}}(this));$scope.currentInterval=3;$scope.$watch("currentInterval",function(_this){return function(newVal,oldVal){var newInterval;newInterval=5e3;switch(newVal){case 1:newInterval=4e4;break;case 2:newInterval=2e4;break;case 3:newInterval=1e4;break;case 4:newInterval=4e3;break;case 5:newInterval=1500}return _this.imageLoader.updateInterval(newInterval)}}(this));$scope.translateInterval=function(val){switch(val){case"1":return"Very slow";case"2":return"Slow";case"3":return"Normal";case"4":return"Fast";case"5":return"Very fast"}};$scope.showAddImage=function(){var loginModal;loginModal=$modal.open({templateUrl:"AddImage.html",controller:"AddImageController",backdrop:false,keyboard:true});return loginModal.result.then(function(){console.log("succ");return loginModal=void 0},function(){console.log("cancelled");return loginModal=void 0})};this.elementToFullScreen=function(_this){return function(i){if(i.requestFullscreen){console.log("1 go fullscreen");return i.requestFullscreen()}else if(i.webkitRequestFullscreen){console.log("webkit go fullscreen");return i.webkitRequestFullscreen()}else if(i.mozRequestFullScreen){console.log("moz go fullscreen");return i.mozRequestFullScreen()}else if(i.msRequestFullscreen){console.log("ms go fullscreen");return i.msRequestFullscreen()}}}(this);$scope.goFullScreen=function(_this){return function(){return _this.elementToFullScreen(document.getElementById("fullscreen"))}}(this);$scope.imageDetails={title:"Loading..",screenRatio:"",imageRatio:"",resizeDiff:"",ratioDiff:""};$scope.showRatios=false;$scope.toggleShowDetails=function(){return $scope.showRatios=!$scope.showRatios};this.showControlBar=function(_this){return function(e){$(window).unbind("mousemove",_this.showControlBar);$(window).unbind("touchstart",_this.showControlBar);$(".js-controlbar").fadeIn();return _this.fadeControlBar()}}(this);$scope.isInFullScreen=false;this.fullScreenChangeHandler=function(_this){return function(){return $scope.isInFullScreen=void 0!==(document.fullScreenElement||document.webkitCurrentFullScreenElement||document.mozFullScreenElement)}}(this);document.addEventListener("fullscreenchange",this.fullScreenChangeHandler,false);document.addEventListener("webkitfullscreenchange",this.fullScreenChangeHandler,false);document.addEventListener("mozfullscreenchange",this.fullScreenChangeHandler,false);this.fadeControlBar=function(_this){return function(){if(_this.timer&&_this.timer>0){clearTimeout(_this.timer)}return _this.timer=setTimeout(function(){$(".js-controlbar").fadeOut(1e3);$(window).mousemove(_this.showControlBar);return $(window).bind("touchstart",_this.showControlBar)},_this.isInFullScreen?2e3:12e3)}}(this);return this.fadeControlBar()});