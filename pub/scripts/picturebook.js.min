/*!
Picturebook
@name picturebook
@author Alexander van Trijffel (@avtnl)
@version 0.0.1
@date 2014-04-21
*/
angular.module("ngApp",["ngRoute","ui.bootstrap","vr.directives.slider"]).config(function(a,b,c,d){return a.when("/",{templateUrl:"start.html",controller:"StartController"}).when("/about",{templateUrl:"about.html",controller:"AboutController",params:c.admin}).otherwise({redirectTo:"/"}),b.html5Mode(!1).hashPrefix("!"),delete d.defaults.headers.common["X-Requested-With"]}).value("rootUrl","LOCALHOST:8080"===window.location.host.toUpperCase()?"http://localhost:3001":"").run(function(a,b,c){return a.$on("$routeChangeStart",function(d,e){return e.authorizedRoles&&!c.isAuthorized(e.authorizedRoles)?(alert("You are not allowed to access this page because you are not a member of "+e.authorizedRoles),d.preventDefault(),a.$broadcast(c.isAuthenticated?b.notAuthorized:b.notAuthenticated)):void 0})}),"undefined"==typeof console&&(window.console={log:function(){}}),angular.module("ngApp").constant("USER_ROLES",{all:"*",admin:"admin",guest:"guest"}).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),angular.module("ngApp").factory("AuthService",function(a,b){return{login:function(a){return b.create("sessionId","alex","admin")},isAuthenticated:function(){return!!b.userId},isAuthorized:function(a){return angular.isArray(a)||(a=[a]),this.isAuthenticated()&&a.indexOf(-1!==b.userRole)}}}),angular.module("ngApp").service("ImageLoader",function(a,b){return this.interval=5e3,this.updateInterval=function(a){return function(b){return 600>=b?void 0:(a.interval=b,a.resetTimeout())}}(this),this.create=function(a){return function(b){return a.images=[],a.index=-1,a.updateCurrentImage=b,a.resetTimeout(),a.displayNext(),a}}(this),this.resetTimeout=function(a){return function(){return a.timer&&a.timer>0&&clearTimeout(a.timer),a.timer=setTimeout(a.onTick,a.interval)}}(this),this.add=function(a){return function(b){return angular.isArray(b)||(b=[b]),a.images.concat(b)}}(this),this.hasMoreImages=function(a){return function(){return a.index+1<a.images.length}}(this),this.displayNext=function(c){return function(){if(!c.hasMoreImages())return-1===c.index||!c.images||c.images.length<c.index?a.get(""+b+"/api/pics",{}).success(function(a){return _.each(a.images,function(a){return c.load(a)})}).error(function(a,b){return void 0}):a.post(""+b+"/api/pics/next",{fromId:c.images[c.index]._id}).success(function(a){return _.each(a.images,function(a){return c.load(a)})}).error(function(a,b){return void 0});if(0!==c.images.length)return c.index+1<c.images.length?c.index++:c.index=0,c.updateCurrentImage(c.images[c.index])}}(this),this.displayPrevious=function(a){return function(){return a.index>0&&a.index--,a.updateCurrentImage(a.images[a.index])}}(this),this.onTick=function(a){return function(){return a.displayNext(),a.timer=setTimeout(a.onTick,a.interval)}}(this),this.load=function(a){return function(b){var c,d,e;c=new Image,c.onload=function(){return a.images.push(c),1===a.images.length?a.displayNext():void 0},e=[];for(d in b)e.push(c[d]=b[d]);return e}}(this),this}),angular.module("ngApp").service("Session",function(){return this.create=function(a,b,c){return this.id=a,this.userId=b,this.userRole=c,this},this.destroy=function(){return this.id=null,this.userId=null,this.userRole=null,this},this}),angular.module("ngApp").directive("focusMe",function(a,b){return{link:function(c,d,e){var f;return f=b(e.focusMe),c.$watch(f,function(b){return b===!0?a(function(){return d[0].focus()}):void 0}),d.bind("blur",function(){return c.$apply(f.assign(c,!1))})}}}),angular.module("ngApp").controller("AboutController",function(){return void 0}),angular.module("ngApp").controller("AddImageController",function(a,b,c){return a.focusImageUrl=!0,a.addResult="",a.closeModal=function(){return a.$close()},a.add=function(){return function(d){return!d||0!==d.imageUrl.indexOf("http://")&&0!==d.imageUrl.indexOf("https://")?a.addResult="Please enter an address starting with http:// or https://":b.post(""+c+"/api/pics",{src:d.imageUrl,title:d.title}).success(function(){var b;return b=angular.element($("#addImageForm")).scope().image,b.imageUrl="",b.title="",a.addResult="Image added successfully."}).error(function(b,c){return a.addResult=""+c+" Failed to add the image."})}}(this)}),angular.module("ngApp").controller("ApplicationController",function(a,b,c,d){return a.currentUser=null,a.userRoles=b,a.isAuthorized=!1,a.showLogin=function(){var a;return a=c.open({templateUrl:"loginModal.html",controller:"LoginController",backdrop:!1,keyboard:!0}),a.result.then(function(){return a=void 0},function(){return a=void 0})},a.$on(d.loginSuccess,function(b,c){return a.currentUser=c})}),angular.module("ngApp").controller("LoginController",function(a,b,c,d,e){return a.credentials={username:"",password:""},a.ok=function(){return e.dismiss()},a.login=function(a){return d.login(a),b.$broadcast(c.loginSuccess,{name:"Alex ("+a.username+")"}),e.close()}}),angular.module("ngApp").controller("StartController",function(a,b,c){return a.imageContainer=$("#fullscreen"),a.image=$("#fullscreen img"),a.keys="",a.currentImage={src:""},this.imageLoader=b.create(function(b){var c,d,e,f,g;return a.currentImage=b,g={x:$(document).width(),y:$(document).height()},f=g.x/g.y,c=b.width/b.height,d=(f/c).toFixed(2),a.imageDetails.title=b.title.length?b.title:"",a.imageDetails.screenRatio="Screen ratio: "+f.toFixed(2),a.imageDetails.imageRatio="Image ratio: "+c.toFixed(2),a.imageDetails.ratioDiff="Ratio diff: "+d,d>1.5?(e=0,b.width>b.height?(e=g.x/b.width,a.image.css("width",g.x),a.image.css("height",e*b.height)):(e=g.y/b.height,a.image.css("height",g.y),a.image.css("width",e*b.width)),a.imageDetails.resizeDiff="Resize diff: "+e.toFixed(2),a.image.attr("src",b.src),a.imageContainer.css("background-image",""),a.image.show()):(a.imageDetails.resizeDiff="",a.image.attr("src",""),a.image.hide(),a.imageContainer.css("background-image","url("+b.src+")")),a.$apply()}),a.hasFullScreen=function(){var a;return a=document.getElementById("fullscreen"),a.requestFullscreen||a.webkitRequestFullscreen||a.mozRequestFullScreen||a.msRequestFullscreen},a.hasFullScreen()||$("#enterfullscreen").hide(),$("body").keyup(function(b){return function(c){return 37===c.keyCode?(a.keys+="LEFT ",b.imageLoader.displayPrevious()):39===c.keyCode&&(a.keys+="RIGHT ",b.imageLoader.displayNext()),a.$apply()}}(this)),a.currentInterval=4,a.$watch("currentInterval",function(a){return function(b){var c;switch(c=5e3,b){case 1:c=4e4;break;case 2:c=2e4;break;case 3:c=1e4;break;case 4:c=4e3;break;case 5:c=1500}return a.imageLoader.updateInterval(c)}}(this)),a.translateInterval=function(a){switch(a){case"1":return"Very slow";case"2":return"Slow";case"3":return"Normal";case"4":return"Fast";case"5":return"Very fast"}},a.showAddImage=function(){var a;return a=c.open({templateUrl:"AddImage.html",controller:"AddImageController",backdrop:!1,keyboard:!0}),a.result.then(function(){return a=void 0},function(){return a=void 0})},this.elementToFullScreen=function(){return function(a){return a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.msRequestFullscreen?a.msRequestFullscreen():void 0}}(this),a.goFullScreen=function(a){return function(){return a.elementToFullScreen(document.getElementById("fullscreen"))}}(this),a.imageDetails={title:"Loading..",screenRatio:"",imageRatio:"",resizeDiff:"",ratioDiff:""},a.showRatios=!1,a.toggleShowDetails=function(){return a.showRatios=!a.showRatios},this.showControlBar=function(a){return function(){return $(window).unbind("mousemove",a.showControlBar),$(window).unbind("touchstart",a.showControlBar),$("#controlbar").fadeIn(),a.fadeControlBar()}}(this),a.isInFullScreen=!1,this.fullScreenChangeHandler=function(){return function(){return a.isInFullScreen=void 0!==(document.fullScreenElement||document.webkitCurrentFullScreenElement||document.mozFullScreenElement)}}(this),document.addEventListener("fullscreenchange",this.fullScreenChangeHandler,!1),document.addEventListener("webkitfullscreenchange",this.fullScreenChangeHandler,!1),document.addEventListener("mozfullscreenchange",this.fullScreenChangeHandler,!1),this.fadeControlBar=function(a){return function(){return a.timer&&a.timer>0&&clearTimeout(a.timer),a.timer=setTimeout(function(){return $("#controlbar").fadeOut(1e3),$(window).mousemove(a.showControlBar),$(window).bind("touchstart",a.showControlBar)},a.isInFullScreen?2e3:12e3)}}(this),this.fadeControlBar()});